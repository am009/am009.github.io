<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title> ucore lab2 | </title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="ucore lab2继续看Intel 80386 Programmer’s Reference Manual, 1987 (HTML)http:&#x2F;&#x2F;www.logix.cz&#x2F;michal&#x2F;doc&#x2F;i386&#x2F;再看Intel® 64 and IA-32 Architectures Software Developer Manualshttps:&#x2F;&#x2F;software.intel.com&#x2F;en-us&#x2F;ar">
<meta property="og:type" content="article">
<meta property="og:title" content=" ucore lab2">
<meta property="og:url" content="http://wjk.moe/os/ucore%20lab2/">
<meta property="og:site_name">
<meta property="og:description" content="ucore lab2继续看Intel 80386 Programmer’s Reference Manual, 1987 (HTML)http:&#x2F;&#x2F;www.logix.cz&#x2F;michal&#x2F;doc&#x2F;i386&#x2F;再看Intel® 64 and IA-32 Architectures Software Developer Manualshttps:&#x2F;&#x2F;software.intel.com&#x2F;en-us&#x2F;ar">
<meta property="og:locale">
<meta property="og:image" content="https://segmentfault.com/img/remote/1460000009450843">
<meta property="article:published_time" content="2019-09-29T05:46:25.000Z">
<meta property="article:modified_time" content="2020-10-07T16:27:32.033Z">
<meta property="article:author" content="am009">
<meta property="article:tag" content="ucore">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://segmentfault.com/img/remote/1460000009450843">
  
    <link rel="alternate" href="/atom.xml" title="" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo"></a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://wjk.moe"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-os/ucore lab2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/os/ucore%20lab2/" class="article-date">
  <time datetime="2019-09-29T05:46:25.000Z" itemprop="datePublished">2019-09-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/OS/">OS</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
       ucore lab2
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="ucore-lab2"><a href="#ucore-lab2" class="headerlink" title="ucore lab2"></a>ucore lab2</h1><p>继续看Intel 80386 Programmer’s Reference Manual, 1987 (HTML)<br><a target="_blank" rel="noopener" href="http://www.logix.cz/michal/doc/i386/">http://www.logix.cz/michal/doc/i386/</a><br>再看Intel® 64 and IA-32 Architectures Software Developer Manuals<br><a target="_blank" rel="noopener" href="https://software.intel.com/en-us/articles/intel-sdm">https://software.intel.com/en-us/articles/intel-sdm</a></p>
<a id="more"></a>

<h3 id="内存管理"><a href="#内存管理" class="headerlink" title="内存管理"></a>内存管理</h3><p>分段机制启动、分页机制未启动：逻辑地址—&gt;段机制处理—&gt;线性地址=物理地址<br>分段机制和分页机制都启动：逻辑地址—&gt;段机制处理—&gt;线性地址—&gt;页机制处理—&gt;物理地址</p>
<p>2^32 = 2^10 * 2^10 * 4k<br>段机制的时候，limit域长20bit，如果以4k为单位，那么就是最大4g<br>页机制，一个页4k字节，4字节一个页，一个页可以放1k个页表，那就是1k × 4k = 4M的内存，页表目录则是保存1k个页表，正好4M × 1000 = 4G</p>
<p>内存分配有几个阶段<br><a target="_blank" rel="noopener" href="https://chyyuu.gitbooks.io/ucore_os_docs/content/lab2/lab2_3_3_5_4_maping_relations.html">https://chyyuu.gitbooks.io/ucore_os_docs/content/lab2/lab2_3_3_5_4_maping_relations.html</a></p>
<h3 id="lab2-宏观内存分配"><a href="#lab2-宏观内存分配" class="headerlink" title="lab2 宏观内存分配"></a>lab2 宏观内存分配</h3><p><img src="https://segmentfault.com/img/remote/1460000009450843"><br>图片来自<a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000009450840">https://segmentfault.com/a/1190000009450840</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">memory: 0009fc00, [00000000, 0009fbff], type &#x3D; 1.</span><br><span class="line">memory: 00000400, [0009fc00, 0009ffff], type &#x3D; 2.</span><br><span class="line">memory: 00010000, [000f0000, 000fffff], type &#x3D; 2.</span><br><span class="line">memory: 07ee0000, [00100000, 07fdffff], type &#x3D; 1.</span><br><span class="line">memory: 00020000, [07fe0000, 07ffffff], type &#x3D; 2.</span><br><span class="line">memory: 00040000, [fffc0000, ffffffff], type &#x3D; 2.</span><br></pre></td></tr></table></figure>
<p>可用内存有两块，一个是从00000000 –&gt; 0009fc00 约1M字节<br>5个十六进制位是20bit，2^10 是1KB,那么2^20就是1M</p>
<p>bios加载bootloader<br>bootblock占512字节 = 0x200.占0x7c00 —&gt; 0x 7dff<br>bootloader探测的内存信息位于0x8000</p>
<p>内核加载到100000，恰好是第二块可用内存的起始地址<br>第二块内存有07ee0000，大概126MB多一点<br>在memlayout.h</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#define KMEMSIZE            0x38000000                  &#x2F;&#x2F; the maximum amount of physical memory</span><br></pre></td></tr></table></figure>
<p>这里限制的物理内存接近1g</p>
<p>然后就是kernel的ELF一路加载下来<br>其中data段有页目录表（约0x0010b000）和第一个页表<br>映射0~4MB的首个页表已经填充好。</p>
<p>0x10e000之后就是Page结构体，有32736个，每一个管理4K内存，和内存总量相符。<br>每一个Page有20字节，所以Pages占了654720字节 = 0x9fd80。占了640K…比想象中大好多<br>page管理物理内存，数量固定，页表数量可能变化，按需创建。<br>0x1add80之后就是用来分配的内存了，我们的kernel总共用了0xadd80=712KB。</p>
<p>如果内存再大的话，如果想对应上整个4g空间，那么Page占的空间还可以大32倍。</p>
<h3 id="diff-lab2-with-lab1"><a href="#diff-lab2-with-lab1" class="headerlink" title="diff lab2 with lab1"></a>diff lab2 with lab1</h3><p><a target="_blank" rel="noopener" href="https://chyyuu.gitbooks.io/ucore_os_docs/content/lab2/lab2_3_2_2_phymemlab_files.html">https://chyyuu.gitbooks.io/ucore_os_docs/content/lab2/lab2_3_2_2_phymemlab_files.html</a><br>简单来说变化不大，变化的部分除了一些不重要的库（cprintf，什么console的命令解析）其他的基本上都要在写lab2的时候碰到，指导书也讲得很详细。<br>可以先git commit lab1_result 之后再把lab2 覆盖进去看看变化。</p>
<h3 id="内存探测"><a href="#内存探测" class="headerlink" title="内存探测"></a>内存探测</h3><p>bootasm.S<br>添加了有关内存分布的汇编代码<br><a target="_blank" rel="noopener" href="https://chyyuu.gitbooks.io/ucore_os_docs/content/lab2/lab2_3_5_probe_phymem_methods.html">https://chyyuu.gitbooks.io/ucore_os_docs/content/lab2/lab2_3_5_probe_phymem_methods.html</a></p>
<h3 id="do-while-0"><a href="#do-while-0" class="headerlink" title="do while(0)"></a>do while(0)</h3><p>kern/sync/sync.h<br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/99efda8dfec9">https://www.jianshu.com/p/99efda8dfec9</a></p>
<h3 id="kern-entry"><a href="#kern-entry" class="headerlink" title="kern_entry"></a>kern_entry</h3><p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000009450840">https://segmentfault.com/a/1190000009450840</a><br><a target="_blank" rel="noopener" href="https://chyyuu.gitbooks.io/ucore_os_docs/content/lab2/lab2_3_3_5_4_maping_relations.html">https://chyyuu.gitbooks.io/ucore_os_docs/content/lab2/lab2_3_3_5_4_maping_relations.html</a></p>
<h3 id="gdb打印变量不对"><a href="#gdb打印变量不对" class="headerlink" title="gdb打印变量不对"></a>gdb打印变量不对</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/jeff_/article/details/53333154">https://blog.csdn.net/jeff_/article/details/53333154</a><br><a target="_blank" rel="noopener" href="http://gcc.gnu.org/onlinedocs/gcc/Debugging-Options.html">http://gcc.gnu.org/onlinedocs/gcc/Debugging-Options.html</a><br>CFLAGS    := -march=i686 -fno-builtin -fno-PIC -Wall -ggdb -m32 -gstabs -nostdinc $(DEFS)<br>修改成<br>CFLAGS    := -march=i686 -fno-builtin -fno-PIC -Wall -ggdb -m32 -gdwarf-4 -nostdinc $(DEFS)<br>目测没有什么其他问题<br>然而<br>造成了print_stackframe()不能打印出行数了</p>
<h3 id="页表映射到自己"><a href="#页表映射到自己" class="headerlink" title="页表映射到自己"></a>页表映射到自己</h3><p>页目录表地址意义： 这个地址开头的线性地址，管理它的页表在哪一个内存页（物理地址）？<br>页表地址意义： 你这个4M的地址范围空间，里面的这个地址页在哪个物理内存页？</p>
<p>如果把页目录表项当成页表项，也就是说，里面的每一个页，都是一个页表。<br>把0xFAC（10 bit）映射到自己，也就是说在0xFAC（10 bit），这4M的虚拟地址，之后加上10bit的页表的虚拟地址前10bit作为index，就可以直接访问到页表了。<br>这就相当于必须要解两次地址，消耗了一次，这样就可以达到只取一次地址的效果了。</p>
<h3 id="invlpg"><a href="#invlpg" class="headerlink" title="invlpg"></a>invlpg</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/cinmyheart/article/details/39994769">https://blog.csdn.net/cinmyheart/article/details/39994769</a><br>TLB 页表缓冲，我还以为只是页目录表缓冲。。。</p>
<p>问： TLB里面有页目录表吗？<br>暂时答：因为缓冲一次就缓冲了整个页表，是否命中的判断就是根据对应的页目录表项对不对，所以可能命中缓冲时完全不需要访问页目录表。。。</p>
<blockquote>
<p>5.2.5 Page Translation Cache<br>For greatest efficiency in address translation, the processor stores the most recently used page-table data in an on-chip cache. Only if the necessary paging information is not in the cache must both levels of page tables be referenced.</p>
<p>The existence of the page-translation cache is invisible to applications programmers but not to systems programmers; operating-system programmers must flush the cache whenever the page tables are changed. The page-translation cache can be flushed by either of two methods:</p>
<ol>
<li><p>By reloading CR3 with a MOV instruction; for example:</p>
<p>MOV CR3, EAX</p>
</li>
<li><p>By performing a task switch to a TSS that has a different CR3 image<br>than the current TSS. (Refer to Chapter 7 for more information on<br>task switching.)</p>
</li>
</ol>
</blockquote>
<p>When to do or not do INVLPG, MOV to CR3 to minimize TLB flushing<br><a target="_blank" rel="noopener" href="https://www.e-learn.cn/content/wangluowenzhang/626493">https://www.e-learn.cn/content/wangluowenzhang/626493</a><br>TLB的那些事儿<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/omnispace/article/details/61415935">https://blog.csdn.net/omnispace/article/details/61415935</a></p>
<h2 id="缺页？"><a href="#缺页？" class="headerlink" title="缺页？"></a>缺页？</h2><p>问题： 现在管理的只是物理内存，那谁管理页表的映设关系？如果某虚拟地址没有对应的页怎么办？<br>还是说lab2其实就没有管这一块？<br>暂时答：似乎确实不管这回事？虽然有一些维护页表项的函数，但是没怎么被调用。<br>先写写lab3吧。</p>
<h3 id="mark-收藏夹"><a href="#mark-收藏夹" class="headerlink" title="mark-收藏夹"></a>mark-收藏夹</h3><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/abbe81dfe016">https://www.jianshu.com/p/abbe81dfe016</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/hezxyz/article/details/95764158">https://blog.csdn.net/hezxyz/article/details/95764158</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://wjk.moe/os/ucore%20lab2/" data-id="ckfy5cz4m0014jsvp7o6p3lg6" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ucore/" rel="tag">ucore</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/main%E5%87%BD%E6%95%B0%E5%90%AF%E5%8A%A8%E4%B8%8EPOSIX-ABI/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
           main函数启动与POSIX-ABI
        
      </div>
    </a>
  
  
    <a href="/os/ucore%20lab1/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"> ucore lab1</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/CTF/">CTF</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/OS/">OS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%A4%A7%E5%AD%A6/">大学</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%A0%91%E8%8E%93%E6%B4%BE/">树莓派</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CTF/" rel="tag">CTF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/raspberrypi/" rel="tag">raspberrypi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/raspbian/" rel="tag">raspbian</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ucore/" rel="tag">ucore</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BC%80%E5%8F%91/" rel="tag">开发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%A0%88/" rel="tag">栈</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/CTF/" style="font-size: 20px;">CTF</a> <a href="/tags/java/" style="font-size: 10px;">java</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/raspberrypi/" style="font-size: 10px;">raspberrypi</a> <a href="/tags/raspbian/" style="font-size: 10px;">raspbian</a> <a href="/tags/ucore/" style="font-size: 20px;">ucore</a> <a href="/tags/%E5%BC%80%E5%8F%91/" style="font-size: 10px;">开发</a> <a href="/tags/%E6%A0%88/" style="font-size: 10px;">栈</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/os/rcore%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"> rcore学习笔记</a>
          </li>
        
          <li>
            <a href="/2019/unlink/"> unlink</a>
          </li>
        
          <li>
            <a href="/2019/HG6201m%E5%85%89%E7%8C%AB%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91/"> 烽火HG6201M交叉编译transmission成功!!</a>
          </li>
        
          <li>
            <a href="/%E4%B8%80%E5%8F%A5%E8%AF%9D/"> 一句话博客</a>
          </li>
        
          <li>
            <a href="/windows%E6%9D%83%E9%99%90/"> windows 权限提升与监控</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 am009<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>